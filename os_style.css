/* File 03: os_core.js */
/* Description: Advanced SPA Logic, Terminal Execution, and WebSocket Connection */

document.addEventListener("DOMContentLoaded", () => {
    console.log("A1 OS Core Initialized.");

    // --- DOM Elements ---
    const loginModal = document.getElementById('login-modal');
    const appContainer = document.getElementById('app-container');
    const loginBtn = document.getElementById('login-btn');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    
    const terminalScreen = document.getElementById('terminal-screen');
    const cmdInput = document.getElementById('cmd-input');
    const execBtn = document.getElementById('exec-btn');
    const killSwitch = document.getElementById('kill-switch');

    // --- WebSockets Setup (Connecting to Python Backend) ---
    // Agar Socket.io load nahi hua hai (jaise local testing bina server ke), to error na aaye isliye try-catch
    let socket;
    try {
        socket = io(); // Flask-SocketIO se connect karega
        
        socket.on('connect', () => {
            printToTerminal("ðŸŸ¢ System Link Established. Connected to A1 Python Backend.", "text-neonGreen");
        });

        // Backend se jo output aayega, wo terminal me dikhega
        socket.on('terminal_output', (data) => {
            printToTerminal(`[A1]: ${data.output}`, "text-gray-300");
        });

    } catch (e) {
        console.warn("Socket.io not found. Running in Frontend Simulation Mode.");
    }

    // --- PHASE 1: LOGIN LOGIC ---
    loginBtn.addEventListener('click', () => {
        const user = usernameInput.value;
        const pass = passwordInput.value;

        // Front-end Gatekeeper (Asli security backend me hai, ye UI ke liye hai)
        if(user === "admin" && pass !== "") {
            loginBtn.innerHTML = "<i class='fas fa-spinner fa-spin'></i> VERIFYING...";
            loginBtn.classList.replace("bg-green-700", "bg-yellow-600");
            
            setTimeout(() => {
                loginModal.classList.add("hidden");
                appContainer.classList.remove("hidden");
                printToTerminal("Welcome Admin. All systems nominal.", "text-neonGreen");
                cmdInput.focus();
            }, 1000); // 1 sec hacker style delay
        } else {
            loginBtn.innerHTML = "ACCESS DENIED";
            loginBtn.classList.replace("bg-green-700", "bg-red-600");
            setTimeout(() => {
                loginBtn.innerHTML = "INITIALIZE CORE";
                loginBtn.classList.replace("bg-red-600", "bg-green-700");
            }, 2000);
        }
    });

    // Enter key support for login
    passwordInput.addEventListener('keypress', (e) => {
        if(e.key === 'Enter') loginBtn.click();
    });

    // --- PHASE 2: TERMINAL & COUNCIL OF EXPERTS LOGIC ---
    function printToTerminal(text, colorClass = "text-white") {
        const div = document.createElement('div');
        div.className = `mb-1 ${colorClass}`;
        div.innerText = text;
        terminalScreen.appendChild(div);
        terminalScreen.scrollTop = terminalScreen.scrollHeight; // Auto-scroll to bottom
    }

    function executeCommand() {
        const command = cmdInput.value.trim();
        if(!command) return;

        // User input show karo
        printToTerminal(`admin@A1-OS:~$ ${command}`, "text-blue-400 font-bold");
        cmdInput.value = '';

        // UI Simulation: Council of Experts Auditing
        printToTerminal("â³ Council of Experts Auditing Command...", "text-yellow-500 text-xs");
        
        setTimeout(() => {
            // Audit Pass hone ke baad backend ko bhejo
            printToTerminal("âœ… Audit Passed. Executing...", "text-green-500 text-xs");
            
            if (socket) {
                // Send to Python Backend
                socket.emit('command_input', command);
            } else {
                // Fallback simulation if backend is off
                setTimeout(() => {
                    printToTerminal(`[Simulated Output]: Executed '${command}' successfully.`, "text-gray-300");
                }, 500);
            }
        }, 800);
    }

    execBtn.addEventListener('click', executeCommand);
    cmdInput.addEventListener('keypress', (e) => {
        if(e.key === 'Enter') executeCommand();
    });

    // --- PHASE 3: RLHF (Human Feedback Logic) ---
    const thumbsUp = document.querySelector('.fa-thumbs-up');
    const thumbsDown = document.querySelector('.fa-thumbs-down');

    thumbsUp.addEventListener('click', () => {
        printToTerminal("ðŸ’¡ RLHF: Positive feedback saved. AI will favor this logic path.", "text-neonGreen text-xs");
    });
    
    thumbsDown.addEventListener('click', () => {
        printToTerminal("âš ï¸ RLHF: Negative feedback saved. AI will avoid this logic path.", "text-red-400 text-xs");
    });

    // --- PHASE 4: EMERGENCY KILL SWITCH ---
    killSwitch.addEventListener('click', () => {
        printToTerminal("ðŸš¨ EMERGENCY OVERRIDE ACTIVATED! FREEZING ALL SYSTEMS...", "text-red-500 font-bold text-lg");
        document.body.classList.add("bg-red-900");
        document.body.style.transition = "background-color 0.5s ease";
        
        if (socket) socket.emit('command_input', 'SYSTEM_FREEZE_PROTOCOL_ACTIVATE');
        
        setTimeout(() => {
            alert("SYSTEM FROZEN. NETWORK DISCONNECTED.");
            location.reload(); // Reloads to login screen
        }, 1500);
    });

    // --- PHASE 5: BUTTON CLICK SIMULATIONS (Hot-Swap, Plugins, Apps) ---
    // Har button par click hone par terminal me command bhejta hai
    document.querySelectorAll('button').forEach(btn => {
        if(btn.id === 'login-btn' || btn.id === 'exec-btn' || btn.id === 'kill-switch') return;

        btn.addEventListener('click', (e) => {
            const btnText = e.target.innerText;
            const cardTitle = e.target.closest('div, td').parentElement.querySelector('h3, td')?.innerText || "Module";
            
            cmdInput.value = `Intent: Execute [${btnText}] on [${cardTitle}]`;
            executeCommand();
        });
    });
});
            
